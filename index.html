<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <title>Lane Blockage Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/styles2.css?version=18">
    <link href="https://vjs.zencdn.net/7.0.3/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.0.3/video.js"></script>

    <style>

     :root {
       --top-color: red;
       --bot-color: green;
     }


     /* Turn boxes */
     .turnBox {
       fill: red;
       stroke: black;
       stroke-width: 2;
     }

     /* Slider */
     .ticks {
       font: 10px sans-serif;
     }

     .topTrack {
       stroke: var(--top-color);
       stroke-width: 8px;
       stroke-linecap: round;
     }

     .botTrack {
       stroke: var(--bot-color);
       stroke-width: 8px;
       stroke-linecap: round;
     }

     /*.track,
        .track-inset,
        .track-overlay {
        stroke-linecap: round;
        }*/

     .fullTrack {
       stroke: #000;
       stroke-opacity: 0.3;
       stroke-width: 11px;
       stroke-linecap: round;
     }

     .track {
       stroke-opacity: 0.3;
       stroke-width: 10px;
     }

     .track-inset {
       stroke-width: 8px;
     }

     .handle {
       fill: #fff;
       stroke: #000;
       stroke-opacity: 0.5;
       stroke-width: 1.25px;
     }

    </style>

  </head>
  <body>

    <div class="tab">
      <button class="tablink" onclick="openCase('LTB', this)" id="defaultOpen">Left Turn Blockage</button>
      <button class="tablink" onclick="openCase('TQSB', this)">Through Queue Spillback</button>
    </div>

    <div id="LTB" class="tabcontent" style="background-color:gray;" >
      <h3> this is the left turn blockage</h3>
      <video id="LTB" class="video-js positioning" controls preload="auto" width="600" height="337.5" data-setup="{}">
        <source src="/Videos/LT-blockage-cropped.mp4" type='video/mp4'>
        <p class="vjs-no-js">
          To view this video please enable JavaScript, and consider upgrading to a web browser that
          <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
        </p>
      </video>
      <svg class="conclusionSVG_LTB positioning" height="400" width="800"> </svg>
    </div>

    <div id="TQSB" class="tabcontent">
      <h3> this is the through QSB</h3>
      <video id="TQSB" class="video-js positioning" controls preload="auto" width="600" height="337.5" data-setup="{}">
        <source src="/Videos/TH-QSB-cropped.mp4" type='video/mp4'>
        <p class="vjs-no-js">
          To view this video please enable JavaScript, and consider upgrading to a web browser that
          <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
        </p>
      </video>
      <svg class="conclusionSVG_TQSB positioning" height="400" width="800"> </svg>

    </div>

    <script>

     var player;
     var duration;
     var timeScale;
     var mapConclusions;
     var leftConclusions;
     var throughConclusions;
     var rightConclusions;
     var currentConclusions;
     var currTurns = new Set();
     var slider;
     var currCase;
     var yScale;

     // Turn box colors
     var selected = 'green';
     var unselected = 'red';

     d3.queue()
       .defer(d3.csv, "Conclusions/tests/test_left_turn.csv", parseRow)
       .defer(d3.csv, "Conclusions/tests/test_through.csv", parseRow)
       .await(set_conclusions);

     function newCase(caseName) {
       // Reset variables
       player = videojs(caseName);
       currTurns = new Set();
       duration = undefined;
       timeScale = undefined;
       mapConclusions = undefined;
       slider = undefined;
       yScale = undefined;

       // Load csv containing conclusions
       switch (caseName) {
         case 'LTB':
           currentConclusions = leftConclusions;
           break;
         case 'TQSB':
           currentConclusions = throughConclusions;
           break;
       }

       duration = player.duration();
       var timeMin = d3.min(currentConclusions, d => d.Time);
       var timeMax = d3.max(currentConclusions, d => d.Time);
       timeScale = d3.scaleLinear().domain([timeMin, timeMax]).range([0, duration]);
       mapConclusions = d3.map(currentConclusions, d => d.videoTime = Math.round(timeScale(d.Time)));

       var svg = d3.select(".conclusionSVG_" + caseName);
       var width = Number(svg.attr('width'));
       var height = Number(svg.attr('height'));
       svg.append('text').attr('class', 'conclusionText').attr('fill', 'black')
          .attr('x', width/2).attr('y', 50)
          .attr('text-anchor', 'middle');
       svg.append('rect').attr('width', width).attr('height', height).attr('stroke', 'black')
          .attr('stroke-width', 2).attr('fill', 'transparent');

       /* Blocks colored by congested turn */
       var blockWidth  = 150;
       var blockHeight = 40;
       var blockX      = (width / 2) - (blockWidth / 2); // Middle of blocks in vertical column

       var leftTurn = svg.append('g').attr('transform', 'translate(' + blockX  + ',' + (height * (1/3))  + ')')
                         .attr('class', 'turn left');
       leftTurn.append('rect').attr('class', 'turnBox leftTurnBox').attr('width', blockWidth).attr('height', blockHeight)

       leftTurn.append('text').text('LEFT').attr('text-anchor', 'middle').attr('x', blockWidth / 2)
               .attr('y', blockHeight / 2).attr('alignment-baseline', 'middle').attr('font-size', 20);

       var through = svg.append('g').attr('transform', 'translate(' + blockX  + ',' + (height * (1/2)) + ')')
                        .attr('class', 'turn, through');
       through.append('rect').attr('class', 'turnBox throughTurnBox').attr('width', blockWidth).attr('height', blockHeight)
       through.append('text').text('THROUGH').attr('text-anchor', 'middle').attr('x', blockWidth / 2)
              .attr('y', blockHeight / 2).attr('alignment-baseline', 'middle').attr('font-size', 20);

       var right = svg.append('g').attr('transform', 'translate(' + blockX + ',' + (height * (2/3)) + ')')
                      .attr('class', 'turn, right');
       right.append('rect').attr('class', 'turnBox rightTurnBox').attr('width', blockWidth).attr('height', blockHeight)
       right.append('text').text('RIGHT').attr('text-anchor', 'middle').attr('x', blockWidth / 2)
            .attr('y', blockHeight / 2).attr('alignment-baseline', 'middle').attr('font-size', 20);

       /* Slider for level of congestion */
       var sliderHeightEnds = 50;
       var sliderHeightMid  = 200;
       yScale = d3.scaleLinear()
                  .domain([0, 100])
                  .range([0, sliderHeightMid])
                  .clamp(true);

       var defs = svg.append("defs");

       var gradient = defs.append("linearGradient")
                          .attr("id", "svgGradient")
                          .attr("x1", "0%")
                          .attr("x2", "0%")
                          .attr("y1", "0%")
                          .attr("y2", "100%");

       gradient.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "red")
               .attr("stop-opacity", 1);

       gradient.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "green")
               .attr("stop-opacity", 1);

       sliderFull = svg.append("g")
                       .attr("class", "slider")
                       .attr("transform", "translate(" + 50 + "," + (((height/2) - (sliderHeightMid/2)) - (sliderHeightEnds))  + ")");

       sliderTop = svg.append("g")
                      .attr("class", "slider")
                      .attr("transform", "translate(" + 50 + "," + (((height/2) - (sliderHeightMid/2)) - (sliderHeightEnds)) + ")");

       sliderBot = svg.append("g")
                      .attr("class", "slider")
                      .attr("transform", "translate(" + 50 + "," + ((height/2) + (sliderHeightMid/2))  + ")");

       slider = svg.append("g")
                   .attr("class", "slider")
                   .attr("transform", "translate(" + 50 + "," + ((height/2) - (sliderHeightMid/2)) + ")");

       sliderFull.append("line")
                 .attr("class", "fullTrack")
                 .attr("y1", 0)
                 .attr("y2", sliderHeightEnds * 2 + sliderHeightMid);

       slider.append("rect")
             .attr('class', 'track')
             .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
             .attr("class", "track-inset")
             .attr("x", -4).attr("y", 0).attr("width", 8).attr("height", yScale.range()[1])
             .attr("fill", "url(#svgGradient)")
             .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
             .attr("class", "track-overlay")

       sliderBot.append("line")
             .attr("class", "botTrack")
             .attr("y1", 0)
             .attr("y2", sliderHeightEnds);


       sliderTop.append("line")
                .attr("class", "topTrack")
                .attr("y1", 0)
                .attr("y2", sliderHeightEnds)

       slider.insert("g", ".track-overlay")
                .attr("class", "ticks")
                .attr("transform", "translate(20,0)")
                .selectAll("text")
                .data(yScale.ticks(4))
                .enter().append("text")
                .attr("y", yScale)
                .attr("text-anchor", "middle")
                .text(d => d);

       var handle = slider.insert("circle", ".track-overlay")
                          .attr("class", "handle")
                          .attr("r", 9)
                          .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })

       player.on('timeupdate', update_conclusion);
       player.play();

     }

     /* Highlight box that corresponds to current conclusion.
        conclusion: string of current conclusion from data. */
     function updateTurnBox(conclusion) {
       conclusion = conclusion.toLocaleLowerCase()
       colorBox('left', conclusion);
       colorBox('through', conclusion);
       colorBox('right', conclusion);
     }

     /* Update currTurns and change turn box color.
        turn:        string of turn, either 'left', 'through', or 'right'
        conclusion:  lowercase string of current conclusion from data
      */
     function colorBox(turn, conclusion){
       var box = d3.selectAll('.' + turn + 'TurnBox');
       if (conclusion.includes(turn)){
         currTurns.add(turn);
         var box = d3.selectAll('.' + turn + 'TurnBox');
         // If box not already active, make it active and transition its color
         if (!box.classed('active')) {
           box.classed('active', true);
           box.transition()
              .styleTween('fill', function () {
                return d3.interpolate(unselected, selected)
              })
              .duration(650)
         }
       } else {
         currTurns.delete(turn);
         // If box was active, make it inactive and transition its color
         if (box.classed('active')){
           box.classed('active', false);
           box.transition()
              .styleTween('fill', function () {
                return d3.interpolate(selected, unselected)
              })
              .duration(650)
         }
       }
     }

     /**
        Update slider position based on conclusion.
      */
     function updateSlider (conclusion) {
       var match = conclusion.match(/(\d+\.\d+)/)
       if (!(match == null)){
         var pos = Number(match[0]);
         d3.selectAll('.handle')
           .transition()
           .duration(650)
           .attr('cy', yScale(pos));
       }
     }

     /**
      * Parse rows of file holding lane blockage conclusions at each time step.
      * Returns: array with entries as {Time:        (time in seconds);
      *                                 Conclusion:  (conclusion as string)}
      */
     function parseRow(row){
       row.Time = Number(row["Time (s)"]);
       row.Conclusion = row["Conclusion"];
       return row;
     }

     function set_conclusions(error, leftConclusion, throughConclusion) {
       leftConclusions = leftConclusion;
       throughConclusions = throughConclusion;
     }

     /* Update conclusion text on page to match current traffic condition. */
     function update_conclusion() {
       var curr_time = Math.round(player.currentTime());
       if ("$" + curr_time in mapConclusions) {
         var entry = mapConclusions["$" + curr_time];
         d3.selectAll('.conclusionText').text(entry.Conclusion);
         updateTurnBox(entry.Conclusion);
         updateSlider(entry.Conclusion);
       }
     }

     function openCase(caseName, elmnt){
       if (typeof(currCase) == 'undefined') {
         currCase = caseName;
       } else if (currCase == caseName){
         // User clicked on tab twice in a row, ignore.
         return;
       } else {
         // Update to new case
         currCase = caseName;
       }

       // Declare all variables
       var i, tabcontent, tablinks;

       // Get all elements with class="tabcontent" and hide them
       tabcontent = document.getElementsByClassName("tabcontent");
       for (i = 0; i < tabcontent.length; i++) {
         tabcontent[i].style.display = "none";
       }

       // Get all elements with class="tablinks" and remove the class "active"
       tablinks = document.getElementsByClassName("tablink");
       for (i = 0; i < tablinks.length; i++) {
         tablinks[i].className = tablinks[i].className.replace(" active", "");
       }

       // Show the current tab, and add an "active" class to the button that opened the tab
       document.getElementById(caseName).style.display = "block";
       elmnt.className += " active";

       // Display new video player, SVG, correct data
       newCase(caseName);

     }

     // Get the element with id="defaultOpen" and click on it
     //document.getElementById("defaultOpen").click();

    </script>

  </body>
</html>

