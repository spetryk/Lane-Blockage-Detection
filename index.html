<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <title>Lane Blockage Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/styles2.css?version=21">
    <link href="https://vjs.zencdn.net/7.0.3/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.0.3/video.js"></script>
    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet'>

    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet'>
    <!-- Le styles -->
    <link rel="stylesheet" href="/lib/css/bootstrap.min.css">

    <!-- Prototype styles -->
    <link rel="stylesheet" href="/lib/css/nav.css">
    <link rel="stylesheet" href="/lib/css/layout.css">
    <link rel="stylesheet" href="/lib/css/typography.css">
    <link rel="stylesheet" href="/lib/css/components.css">
    <link rel="stylesheet" href="/lib/css/infographics.css">
    <link rel="stylesheet" href="/lib/css/utils.css">
    <link rel="stylesheet" href="/lib/css/entypo.css">

    <!-- Owl stylesheets -->
    <link rel="stylesheet" href="/lib/css/owl.carousel.css">
    <link rel="stylesheet" href="/lib/css/owl.theme.css">

    <!-- Yamm! Menus -->
    <link rel="stylesheet" href="/lib/css/yamm.css">

    <!-- Site Specific CSS -->
    <link rel="stylesheet" href="/lib/css/site.css">

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/lib/css/custom.css">


    <style>

     :root {
       --top-color: red;
       --bot-color: green;
     }


     /* Turn boxes */
     .turnBox {
       fill: #ccc;
       stroke: black;
       stroke-width: 2;
       rx: 20;
       ry: 20;
       opacity: 0.5;
     }
     .turnBoxText {
       font-family: 'Ubuntu', sans-serif;
       font-size: 30px;
       text-anchor: middle;
       alignment-baseline: middle;
       font-weight: bold;
       stroke: black;
       stroke-width: 1px;
       fill: transparent;
       letter-spacing: 0.1em;
     }

     /* Slider */
     .ticks {
       font: 10px sans-serif;
     }

     .topTrack {
       stroke: var(--top-color);
       stroke-width: 8px;
       stroke-linecap: round;
     }

     .botTrack {
       stroke: var(--bot-color);
       stroke-width: 8px;
       stroke-linecap: round;
     }

     .fullTrack {
       stroke: #000;
       stroke-opacity: 0.3;
       stroke-width: 11px;
       stroke-linecap: round;
     }

     .track-inset {
       stroke-width: 8px;
     }

     .handle {
       fill: #fff;
       stroke: #000;
       stroke-opacity: 0.5;
       stroke-width: 1.25px;
     }

    </style>

  </head>
  <body>

    <header id="site-header" class="subbrand light">
      <div class="navbar navbar-default navbar-static-top yamm">
        <div class="container"> <a href="http://berkeley.edu" class="home-link">UC Berkeley</a>
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header two-line-logo"><br>
            <h1><img src="/img/berkeleyLogo.png" alt="Berkeley Logo" style="width:200px;height:70px;"><span class="dept-title two-line-logo">California PATH<br>
              Lane Blockage Detection</span></h1>
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-nav"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
          </div>
        </div><br>
        <!-- /.container-fluid -->
      </div>
    </header>

    <section class="header-bar">
      <div class="container">
    	<h2>Lane Blockage Detection Visualization</h2>
      </div>
    </section>

    <div class="visualizationBkg">
      <div class="bkgTextDiv">
        <h4 class="bkgText">
          Information about visualization
        </h4>
        <p class="lead"> Testing out lead text font</p>
      </div>

      <div class="visualization">
        <div class="tab">
          <button class="tablink" onclick="openCase('LTB', this)" id="defaultOpen">Left Turn Blockage</button>
          <button class="tablink" onclick="openCase('TQSB', this)">Through Queue Spillback</button>
          <button class="tablink" onclick="openCase('UC', this)">Uncongested Traffic</button>
        </div>

        <div id="LTB" class="tabcontent" style="background-color:gray;" >
          <h3> this is the left turn blockage</h3>
          <div class="col-container">
            <div class="col">
              <video id="LTB" class="video-js positioning" controls preload="auto" width="600" height="337.5" data-setup="{}">
                <source src="/Videos/LT-blockage-cropped.mp4" type='video/mp4'>
                <p class="vjs-no-js">
                  To view this video please enable JavaScript, and consider upgrading to a web browser that
                  <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                </p>
              </video>
            </div>
            <div class="col" id="svgLTB"></div>
          </div>
        </div>

        <div id="TQSB" class="tabcontent">
          <h3> this is the through QSB</h3>
          <div class="col-container">
            <div class="col">
            <video id="TQSB" class="video-js positioning" controls preload="auto" width="600" height="337.5" data-setup="{}">
              <source src="/Videos/TH-QSB-cropped.mp4" type='video/mp4'>
              <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a web browser that
                <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
              </p>
            </video>
            </div>
            <div class="col" id="svgTQSB"></div>
          </div>
        </div>

        <div id="UC" class="tabcontent" style="background-color:gray;">
          <h3> this is uncongested</h3>
          <div class="col-container">
            <div class="col">
            <video id="UC" class="video-js positioning" controls preload="auto" width="600" height="337.5" data-setup="{}">
              <source src="/Videos/Uncongested-cropped.mp4" type='video/mp4'>
              <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a web browser that
                <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
              </p>
            </video>
            </div>
            <div class="col" id="svgTQSB"></div>
          </div>
        </div>
      </div>
    </div>

    <footer id="universal-footer">
      <div class="container">
	<div class="row">
	  <div class="col-xs-6 col-sm-4 col-md-3">
	    <div class="block logo">
	      <a href="http://www.berkeley.edu/"><img src="/lib/img/logo-ucberkeley-white.png" alt="University of California Berkeley"></a>
	    </div>

	  </div>
	  <div class="col-xs-12 col-sm-8 col-md-9">

	    <div class="copyright">

	      Copyright &copy;  2018  UC Regents; all rights reserved
	    </div>
	  </div>
	</div>

      </div>
    </footer>

    <script>

     var player;
     var duration;
     var timeScale;
     var mapConclusions;
     var leftConclusions;
     var throughConclusions;
     var uncongestedConclusions;
     var rightConclusions;
     var currentConclusions;
     var currTurns = new Set();
     var slider;
     var currCase;
     var yScale;

     // Turn box colors
     var selected = "red";
     var unselected = "#ccc";

     // Lengths of slider ends
     var sliderHeightEnds = 50;
     var sliderHeightMid  = 200;

     d3.queue()
       .defer(d3.csv, "Conclusions/tests/test_left_turn.csv", parseRow)
       .defer(d3.csv, "Conclusions/tests/test_through.csv", parseRow)
       .defer(d3.csv, "Conclusions/tests/test_uncongested.csv", parseRow)
       .await(set_conclusions);

     function newCase(caseName) {
       // Reset variables
       player = videojs(caseName);
       currTurns = new Set();
       duration = undefined;
       timeScale = undefined;
       mapConclusions = undefined;
       yScale = undefined;

       // Load csv containing conclusions
       switch (caseName) {
         case 'LTB':
           currentConclusions = leftConclusions;
           break;
         case 'TQSB':
           currentConclusions = throughConclusions;
           break;
         case 'UC':
           currentConclusions = uncongestedConclusions;
           break;
       }

       duration = player.duration();
       var timeMin = d3.min(currentConclusions, d => d.Time);
       var timeMax = d3.max(currentConclusions, d => d.Time);
       timeScale = d3.scaleLinear().domain([timeMin, timeMax]).range([0, duration]);
       mapConclusions = d3.map(currentConclusions, d => d.videoTime = Math.round(timeScale(d.Time)));

       Element.prototype.remove = function() {
         this.parentElement.removeChild(this);
       }
       NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
         for(var i = this.length - 1; i >= 0; i--) {
           if(this[i] && this[i].parentElement) {
             this[i].parentElement.removeChild(this[i]);
           }
         }
       }

       // Remove previous SVG if it exists
       if (document.getElementsByClassName("svgElem").length > 0) {
         document.getElementsByClassName("svgElem").remove();
       }
       // Add SVG
       var svg = d3.select("#svg" + caseName).append("svg").attr("height", 400).attr("width", 800).attr("class", "svgElem positioning")

       var width = Number(svg.attr('width'));
       var height = Number(svg.attr('height'));
       svg.append('text').attr('class', 'conclusionText').attr('fill', 'black')
          .attr('x', width/2).attr('y', 50)
          .attr('text-anchor', 'middle');
       svg.append('rect').attr('width', width).attr('height', height).attr('stroke', 'black')
          .attr('stroke-width', 2).attr('fill', 'transparent');

       /* Blocks colored by congested turn*/

       var defs = svg.append("defs");

       svg.append("text").text("FOOO").attr("x", 100).attr("y", 100)
          .attr("font-size", 30)
          .attr("text-anchor", "middle")
          .style("text-shadow", "0 0 3px red");


       var blockWidth  = 110;
       var blockHeight = 75;
       var blockX      = (width / 2) - (blockWidth / 2); // Middle of blocks in vertical column

       var leftTurn = svg.append('g').attr('transform', 'translate(' + blockX  + ',' + (height * (1/4))  + ')')
                         .attr('class', 'turn left');
       leftTurn.append('rect').attr('class', 'turnBox leftTurnBox').attr('width', blockWidth).attr('height', blockHeight)
       leftTurn.append('text').text('LEFT').attr("class", "turnBoxText").attr('x', blockWidth / 2).attr('y', blockHeight / 2)

       var through = svg.append('g').attr('transform', 'translate(' + blockX  + ',' + (height * (1/2)) + ')')
                        .attr('class', 'turn, through');
       through.append('rect').attr('class', 'turnBox throughTurnBox').attr('width', blockWidth).attr('height', blockHeight)
       through.append('text').text('THROUGH').attr("class", "turnBoxText").attr('x', blockWidth / 2).attr('y', blockHeight / 2)

       var right = svg.append('g').attr('transform', 'translate(' + blockX + ',' + (height * (3/4)) + ')')
                      .attr('class', 'turn, right');
       right.append('rect').attr('class', 'turnBox rightTurnBox').attr('width', blockWidth).attr('height', blockHeight)
       right.append('text').text('RIGHT').attr("class", "turnBoxText").attr('x', blockWidth / 2).attr('y', blockHeight / 2)

       /* Box indicating queue spillback */
       var qsb = svg.append('g').attr('transform', 'translate(' + ((width * (4/5)) - (blockWidth/2)) + ',' + (height * (1/2)) + ')')
                    .attr('class', 'qsb');
       qsb.append('rect').attr('class', 'turnBox qsbBox').attr('width', blockWidth).attr('height', blockHeight)
       qsb.append('text').text('QUEUE').attr("class", "turnBoxText").attr('x', blockWidth / 2).attr('y', blockHeight *(1/3))
       qsb.append('text').text('SPILLBACK').attr("class", "turnBoxText").attr('x', blockWidth / 2).attr('y', blockHeight *(2/3))

       /* Slider for level of congestion */
       yScale = d3.scaleLinear()
                  .domain([0, 100])
                  .range([sliderHeightMid, 0])
                  .clamp(true);

       var gradient = defs.append("linearGradient")
                          .attr("id", "svgGradient")
                          .attr("x1", "0%")
                          .attr("x2", "0%")
                          .attr("y1", "0%")
                          .attr("y2", "100%");

       gradient.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "red")
               .attr("stop-opacity", 1);

       gradient.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "green")
               .attr("stop-opacity", 1);

       var sliderBkg = svg.append("g")
                          .attr("class", "slider sliderBkg")
                          .attr("transform", "translate(" + 50 + "," + (((height/2) - (sliderHeightMid/2)) - (sliderHeightEnds))  + ")");

       var sliderTop = svg.append("g")
                          .attr("class", "slider sliderTop")
                          .attr("transform", "translate(" + 50 + "," + (((height/2) - (sliderHeightMid/2)) - (sliderHeightEnds)) + ")");

       var sliderBot = svg.append("g")
                          .attr("class", "sliderBot")
                          .attr("transform", "translate(" + 50 + "," + ((height/2) + (sliderHeightMid/2))  + ")");

       var sliderMid = svg.append("g")
                          .attr("class", "sliderMid")
                          .attr("transform", "translate(" + 50 + "," + ((height/2) - (sliderHeightMid/2)) + ")");

       sliderBkg.append("line")
                .attr("class", "fullTrack")
                .attr("y1", 0)
                .attr("y2", sliderHeightEnds * 2 + sliderHeightMid);

       sliderMid.append("g")
                .attr("class", "track-overlay")
       d3.select(".track-overlay")
                .append("g")
                .attr("class", "track-inset")

       sliderBot.append("line")
                .attr("class", "botTrack")
                .attr("y1", 0)
                .attr("y2", sliderHeightEnds);

       sliderTop.append("line")
                .attr("class", "topTrack")
                .attr("y1", 0)
                .attr("y2", sliderHeightEnds)

       d3.select(".track-inset")
                .append("rect")
                .attr("x", -4).attr("y", 0).attr("width", 8).attr("height", yScale.range()[0])
                .attr("fill", "url(#svgGradient)");

       d3.select(".track-overlay")
         .append("g")
         .attr("class", "ticks")
         .attr("transform", "translate(-15,0)")
         .selectAll("text")
         .data(yScale.ticks(4))
         .enter().append("text")
         .attr("y", yScale)
         .attr("text-anchor", "end")
         .text(d => d + " %");

       var handle = d3.select(".track-overlay")
                      .append("circle")
                      .attr("class", "handle")
                      .attr("r", 9);

       sliderMid.insert("text").attr("class", "handleText").attr("x", 15).attr("text-anchor", "start");

       player.on('timeupdate', update_conclusion);

     }

     /* Highlight box that corresponds to current conclusion.
        conclusion: string of current conclusion from data. */
     function updateTurnBox(conclusion) {
       conclusion = conclusion.toLocaleLowerCase()
       colorBox('left', conclusion);
       colorBox('through', conclusion);
       colorBox('right', conclusion);
     }

     /* Update currTurns and change turn box color.
        turn:        string of turn, either 'left', 'through', or 'right'
        conclusion:  lowercase string of current conclusion from data
      */
     function colorBox(turn, conclusion){
       var box = d3.selectAll('.' + turn + 'TurnBox');
       if (conclusion.includes(turn)){
         currTurns.add(turn);
         var box = d3.selectAll('.' + turn + 'TurnBox');
         // If box not already active, make it active and transition its color
         if (!box.classed('active')) {
           box.classed('active', true);
           box.transition()
              .styleTween('fill', function () {
                return d3.interpolate(unselected, selected)
              })
              .duration(650)
         }
       } else {
         currTurns.delete(turn);
         // If box was active, make it inactive and transition its color
         if (box.classed('active')){
           box.classed('active', false);
           box.transition()
              .styleTween('fill', function () {
                return d3.interpolate(selected, unselected)
              })
              .duration(650)
         }
       }
     }

     /**
        Update slider position based on conclusion.
      */
     function updateSlider (conclusion) {
       var lower = conclusion.toLocaleLowerCase()
       var pos;
       var txt;
       // Congested state
       var matchPercent = lower.match(/(\d+\.\d+)/)
       if (!(matchPercent == null)){
         pos = yScale(Number(matchPercent[0]));
         var displayMatch = conclusion.match(/(.*% Congested).*/)
         console.assert(!(displayMatch == null))
         txt = displayMatch[1];
       }
       // Uncongested state
       else if (lower.includes("no lane blockage")){
         pos = yScale(0) + (sliderHeightEnds / 2);
         txt = conclusion;
       }
       // Lane Blockage
       else if (lower.includes("lane blockage")){
         pos = yScale(100) - (sliderHeightEnds / 2);
         txt = "Lane Blockage";
       }
       else {
         pos = 0;
         txt = "foo";
       }
       d3.selectAll('.handle')
         .transition()
         .duration(500)
         .attr('cy', pos);
       d3.selectAll('.handleText')
         .transition()
         .duration(500)
         .attr('y', pos)
         .text(txt);
     }

     /**
      * Parse rows of file holding lane blockage conclusions at each time step.
      * Returns: array with entries as {Time:        (time in seconds);
      *                                 Conclusion:  (conclusion as string)}
      */
     function parseRow(row){
       row.Time = Number(row["Time (s)"]);
       row.Conclusion = row["Conclusion"];
       return row;
     }

     /* Store data from csv reads into variables */
     function set_conclusions(error, leftConclusion, throughConclusion, uncongestedConclusion) {
       leftConclusions        = leftConclusion;
       throughConclusions     = throughConclusion;
       uncongestedConclusions = uncongestedConclusion;
     }

     /* Update conclusion text on page to match current traffic condition. */
     function update_conclusion() {
       var curr_time = Math.round(player.currentTime());
       if ("$" + curr_time in mapConclusions) {
         var entry = mapConclusions["$" + curr_time];
         d3.selectAll('.conclusionText').text(entry.Conclusion);
         updateTurnBox(entry.Conclusion);
         updateSlider(entry.Conclusion);
       }
     }

     function openCase(caseName, elmnt){
       if (typeof(currCase) == 'undefined') {
         currCase = caseName;
       } else if (currCase == caseName){
         // User clicked on tab twice in a row, ignore.
         return;
       } else {
         // Update to new case
         currCase = caseName;
       }

       // Declare all variables
       var i, tabcontent, tablinks;

       // Get all elements with class="tabcontent" and hide them
       tabcontent = document.getElementsByClassName("tabcontent");
       for (i = 0; i < tabcontent.length; i++) {
         tabcontent[i].style.display = "none";
       }

       // Get all elements with class="tablinks" and remove the class "active"
       tablinks = document.getElementsByClassName("tablink");
       for (i = 0; i < tablinks.length; i++) {
         tablinks[i].className = tablinks[i].className.replace(" active", "");
       }

       // Show the current tab, and add an "active" class to the button that opened the tab
       document.getElementById(caseName).style.display = "block";
       elmnt.className += " active";

       // Display new video player, SVG, correct data
       newCase(caseName);

     }

     // Get the element with id="defaultOpen" and click on it
     //document.getElementById("defaultOpen").click();

    </script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

  </body>
</html>

